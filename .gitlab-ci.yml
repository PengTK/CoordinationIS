stages:
  - validate
  - test
  - func

variables:
  MICRONAUT_GRADLE_PROPERTIES: "gradle.properties"

test_build:
  stage: test
  before_script:
    - export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64 && export PATH=$JAVA_HOME/bin:$PATH
  script:
    - echo "Начало теста билда"
    - chmod +x gradlew
    - ./gradlew build -x test --no-daemon -Dorg.gradle.java.installations.auto-detect=false
    - echo "Тест билда завершён"

lint:
  before_script:
    - export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64 && export PATH=$JAVA_HOME/bin:$PATH
  stage: validate
  script:
    - echo "Начало теста синтаксиса"
    - chmod +x gradlew
    - ./gradlew checkstyleMain checkstyleTest
    - echo "Конец теста синтаксиса"
  allow_failure: true

function_secret:
  before_script:
    - export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64 && export PATH=$JAVA_HOME/bin:$PATH
  stage: func
  script:
    - chmod +x gradlew
    - grep -rE "(password|secret|token|apiKey)" --include="*.java" --include="*.yml" --include="*.properties" src/ config/ 2>/dev/null | grep -v "// " | grep -v "# "
  allow_failure: true

function_TODO:
  before_script:
    - export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64 && export PATH=$JAVA_HOME/bin:$PATH
  stage: func
  script:
    - grep -r "TODO" --include="*.java" --include="*.kt" src/main/ 2>/dev/null
  allow_failure: true

#validate-gradle-properties:
#  stage: validate
#  before_script:
#    - python3 -m venv $VENV_PATH
#    - source $VENV_PATH/bin/activate
#    - pip install --upgrade pip
#    - pip install -r requirments.txt
#  script:
#    - echo "Проверка настроек Micronaut"
#    - python3 manage.py check
#    - echo "Настройки Micronaut валидны"
#
#validate-migrations:
#  stage: test
#  before_script:
#  script:
#    - echo "На"
#    - python3 manage.py makemigrations --check --dry-run
#    - echo "Миграции Micronaut валидны"
#
#test-staticfiles:
#  stage: test
#  before_script:
#    - python3 -m venv $VENV_PATH
#    - source $VENV_PATH/bin/activate
#    - pip install --upgrade pip
#    - pip install -r requirments.txt
#  script:
#    - echo "Проверка статик-файлов Micronaut"
#    - python3 manage.py makemigrations collectstatic --noinput --dryrun
#    - echo "Статические файлы Micronaut валидны"