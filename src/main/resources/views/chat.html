<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${chat.name != null ? chat.name : '–ß–∞—Ç'}">–ß–∞—Ç ‚Äî COORDIS</title>
    <link rel="stylesheet" th:href="@{/static/css/style.css}">
    <style>
        .chat-container {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
            max-height: calc(100vh - 150px);
        }
        .chat-messages {
            flex: 1;
            background-color: #111;
            border: 1px solid #222;
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px);
        }
        .chat-participants {
            width: 250px;
            background-color: #111;
            border: 1px solid #222;
            border-radius: 8px;
            padding: 1.5rem;
        }
        .messages-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            padding-right: 1rem;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            max-width: 80%;
        }
        .message.own {
            background-color: #00bfff;
            color: #0a0a0a;
            margin-left: auto;
        }
        .message.other {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        .message-author {
            font-weight: 600;
        }
        .message-time {
            color: #888;
        }
        .message-content {
            line-height: 1.5;
        }
        .message-input {
            display: flex;
            gap: 0.5rem;
        }
        .message-input textarea {
            flex: 1;
            padding: 0.75rem;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            color: #e0e0e0;
            resize: none;
        }
        .participant-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: #1a1a1a;
            border-radius: 4px;
        }
        .participant-name {
            font-weight: 600;
            color: #e0e0e0;
        }
        .participant-role {
            font-size: 0.8rem;
            color: #00bfff;
        }
    </style>
</head>
<body>
<header>
    <a href="/home" class="logo">COORDIS</a>
    <div th:if="${email != null}" class="auth-buttons nav-right">
        <a href="/chats">‚Üê –ù–∞–∑–∞–¥ –∫ —á–∞—Ç–∞–º</a>
    </div>
</header>

<main style="max-width: 1400px; margin: 2rem auto; padding: 0 1rem;">

    <div class="chat-container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="chat-messages">
            <div style="margin-bottom: 1rem;">
                <h3 style="margin: 0; color: #e0e0e0;" th:text="${chat.name != null ? chat.name : '–ß–∞—Ç'}"></h3>
                <p style="color: #888; margin: 0.5rem 0 0 0;" th:text="${chat.type}"></p>
            </div>

            <div class="messages-list" id="messagesList">
                <div th:each="message : ${messages}" class="message"
                     th:classappend="${message.author.id == currentUser.id} ? 'own' : 'other'">
                    <div class="message-header">
                        <span class="message-author" th:text="${message.author.name}"></span>
                        <span class="message-time" th:text="${#temporals.format(message.createdAt, 'HH:mm')}"></span>
                    </div>
                    <div class="message-content" th:text="${message.content}"></div>
                </div>
            </div>

            <div class="message-input">
                <textarea id="messageInput" rows="2" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                          style="width: 100%;"></textarea>
                <button onclick="sendMessage()" class="cta-button" style="padding: 0.75rem 1.5rem;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: —É—á–∞—Å—Ç–Ω–∏–∫–∏ -->
        <div class="chat-participants">
            <h4 style="margin-top: 0; color: #e0e0e0;">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span th:text="${participants.size()}">0</span>)</h4>

            <div th:each="participant : ${participants}" class="participant-item">
                <div class="participant-name" th:text="${participant.user.name}"></div>
                <div class="participant-role" th:text="${participant.isAdmin ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–£—á–∞—Å—Ç–Ω–∏–∫'}"></div>
            </div>

            <div th:if="${chat.project != null}" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #222;">
                <h4 style="color: #e0e0e0; margin: 0 0 0.5rem 0;">–ü—Ä–æ–µ–∫—Ç</h4>
                <a th:href="@{/projects/{id}(id=${chat.project.id})}"
                   style="color: #00bfff; text-decoration: none; display: block; padding: 0.5rem; background-color: #1a1a1a; border-radius: 4px;">
                    <span th:text="${chat.project.title}"></span>
                </a>
            </div>
        </div>
    </div>
</main>

<!-- –°–ø–æ—Å–æ–± 1: —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç (—Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π) -->
<div id="chatData"
     th:data-chat-id="${chat.id}"
     th:data-user-id="${currentUser.id}"
     style="display: none;"></div>

<script>
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤
    const chatData = document.getElementById('chatData');
    const chatId = parseInt(chatData.dataset.chatId);
    const currentUserId = parseInt(chatData.dataset.userId);

    console.log('Chat ID:', chatId);
    console.log('Current User ID:', currentUserId);

    if (isNaN(chatId) || chatId === 0) {
        alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç. ID —á–∞—Ç–∞: ' + chatId);
        console.error('Chat ID is invalid:', chatId);
    }

    let lastMessageTime = new Date();

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();

        if (content === '') return;

        try {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç', chatId, ':', content);

            const encodedContent = encodeURIComponent(content);
            const response = await fetch(`/chats/${chatId}/message?content=${encodedContent}`, {
                method: 'POST'
            });

            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.ok);

            if (response.ok) {
                input.value = '';
                loadNewMessages();
            } else {
                const errorText = await response.text();
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + errorText);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
        }
    }

    async function loadNewMessages() {
    if (isNaN(chatId) || chatId === 0) {
        console.error('Invalid chatId:', chatId);
        return;
    }

    try {
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ ISO-8601
        const sinceStr = lastMessageTime.toISOString()
            .replace('Z', '')  // –£–±–∏—Ä–∞–µ–º 'Z' –≤ –∫–æ–Ω—Ü–µ
            .slice(0, 19);     // –¢–æ–ª—å–∫–æ –¥–æ —Å–µ–∫—É–Ω–¥: "2026-02-03T12:14:05"

        console.log('üîÑ –ó–∞–ø—Ä–æ—Å –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å:', sinceStr);

        const response = await fetch(`/chats/${chatId}/messages/since?since=${sinceStr}`);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
            return;
        }

        const newMessages = await response.json();
        console.log('üì• –ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', newMessages.length);

        if (newMessages.length > 0) {
            const messagesList = document.getElementById('messagesList');

            newMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ' + (msg.author.id == currentUserId ? 'own' : 'other');

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-author">${msg.author.name}</span>
                        <span class="message-time">${new Date(msg.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="message-content">${msg.content}</div>
                `;

                messagesList.appendChild(messageDiv);
            });

            messagesList.scrollTop = messagesList.scrollHeight;
            lastMessageTime = new Date();
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
    }
}


    setInterval(loadNewMessages, 3000);

    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', loadNewMessages);
</script>
</body>
</html>